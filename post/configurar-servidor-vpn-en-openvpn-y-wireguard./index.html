<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">

    
    <meta itemprop="name" content="Configurar servidor VPN en OpenVPN y WireGuard. | Cutreblog">
    <meta itemprop="description" content="En esta práctica veremos como configurar servidores VPN.">

    
    <meta name="twitter:title" content="Configurar servidor VPN en OpenVPN y WireGuard. | Cutreblog">
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:description" content="En esta práctica veremos como configurar servidores VPN.">
    <meta name="twitter:site" content="@ReeseCodes">
    <meta name="twitter:creator" content="@ReeseCodes">
    <meta name="twitter:image:src" content="https://reeseschultz.github.io/twitter.jpg">

    
    <meta name="og:title" content="Configurar servidor VPN en OpenVPN y WireGuard. | Cutreblog">
    <meta name="og:description" content="En esta práctica veremos como configurar servidores VPN.">
    <meta name="og:image" content="https://reeseschultz.github.io/og.jpg">
    <meta name="og:url" content="https://reeseschultz.github.io/">
    <meta name="og:site_name" content="Cutreblog">
    <meta name="og:locale" content="en_GB">
    <meta name="og:type" content="website">

    <link rel="icon" type="image/x-icon" href="/logo.png" />

    <title>Configurar servidor VPN en OpenVPN y WireGuard. | Cutreblog</title>

    <link rel="stylesheet" href="/assets/main.bundle.css">

    
  </head>
  <body class="flex flex-col min-h-screen">
    <header>
  <nav class="container mx-auto max-w-3xl px-8 pt-2 flex flex-wrap justify-between">
    <div>
      <h1>
        <a href="/">Cutreblog</a>
      </h1>
      <p>Blog de Alejandro Montes</p>
    </div>

    <ul class="flex flex-wrap sm:w-32 w-full mt-6 md:justify-between justify-evenly">
      <li>
        <a href="/404.html">404</a>
      </li>

      <li>
        <a href="/about">Sobre mí.</a>
      </li>
    </ul>
  </nav>
</header>

    <main class="container mx-auto max-w-3xl p-8 grow">
      
    <p></p>
    <div>
        <h2>Configurar servidor VPN en OpenVPN y WireGuard.</h2>

        
            <p class="excerpt">En esta práctica veremos como configurar servidores VPN.</p>
        

        
            <div class="mb-2">
                <a class="tag SAD" href="/tag/SAD">SAD</a>
            </div>
        

        
            
                <p class="text-sm italic">Creado en
                    <span datetime="Tue Jan 10 2023 01:00:00 GMT+0100 (hora estándar de Europa central)">January 10, 2023</span>.</p>
            
        

        <div class="content post">
            
                <hr />

                <h3>Tabla de Contenido.</h3>

                <nav class="toc">
                <ol>
                    
                    <li><a href="#openvpn">OpenVPN</a>
            
                <ol>
                    
                    <li><a href="#1.1.-vpn-de-acceso-remoto-con-openvpn-y-certificados-x509.-(5-puntos)">1.1. VPN de acceso remoto con OpenVPN y certificados x509. (5 puntos)</a>
            
                <ol>
                    
                    <li><a href="#configuraci%C3%B3n-del-servidor.">Configuración del servidor.</a>
            		</li>

                    <li><a href="#configuraci%C3%B3n-del-cliente-vpn.">Configuración del cliente VPN.</a>
            		</li>
                </ol>
            		</li>

                    <li><a href="#1.2.-vpn-sitio-a-sitio-con-openvpn-y-certificados-x509.-(10-puntos)">1.2. VPN sitio a sitio con OpenVPN y certificados x509. (10 puntos)</a>
            
                <ol>
                    
                    <li><a href="#configuraci%C3%B3n-del-servidor1.">Configuración del servidor1.</a>
            		</li>

                    <li><a href="#configuraci%C3%B3n-del-cliente1.">Configuración del cliente1.</a>
            		</li>

                    <li><a href="#configuraci%C3%B3n-del-servidor2">Configuración del servidor2</a>
            		</li>

                    <li><a href="#configuraci%C3%B3n-cliente-2.">Configuración cliente 2.</a>
            		</li>

                    <li><a href="#comprobaciones.">Comprobaciones.</a>
            		</li>
                </ol>
            		</li>
                </ol>
            		</li>

                    <li><a href="#wireguard">WireGuard</a>
            
                <ol>
                    
                    <li><a href="#2.1.-vpn-de-acceso-remoto-con-wireguard.-(5-puntos)">2.1. VPN de acceso remoto con WireGuard. (5 puntos)</a>
            
                <ol>
                    
                    <li><a href="#configuraci%C3%B3n-del-servidor%3A">Configuración del servidor:</a>
            		</li>

                    <li><a href="#configuraci%C3%B3n-cliente-debian.">Configuración cliente debian.</a>
            		</li>
                </ol>
            		</li>

                    <li><a href="#2.2.-vpn-sitio-a-sitio-con-wireguard.-(10-puntos)">2.2. VPN sitio a sitio con WireGuard. (10 puntos)</a>
            		</li>
                </ol>
            		</li>
                </ol>
            </nav>

                <hr />
            

            <h3 id="openvpn" tabindex="-1">OpenVPN</h3>
<h4 id="1.1.-vpn-de-acceso-remoto-con-openvpn-y-certificados-x509.-(5-puntos)" tabindex="-1">1.1. VPN de acceso remoto con OpenVPN y certificados x509. (5 puntos)</h4>
<p><strong>Configura una conexión VPN de acceso remoto entre dos equipos del cloud:</strong></p>
<ul>
<li><strong>Uno de los dos equipos (el que actuará como servidor) estará conectado a dos redes</strong></li>
<li><strong>Para la autenticación de los extremos se usarán obligatoriamente certificados digitales, que se generarán utilizando openssl y se almacenarán en el directorio /etc/openvpn, junto con  los parámetros Diffie-Helman y el certificado de la propia Autoridad de Certificación.</strong></li>
<li><strong>Se utilizarán direcciones de la red 10.99.99.0/24 para las direcciones virtuales de la VPN. La dirección 10.99.99.1 se asignará al servidor VPN.</strong></li>
<li><strong>Los ficheros de configuración del servidor y del cliente se crearán en el directorio /etc/openvpn de cada máquina, y se llamarán servidor.conf y cliente.conf respectivamente.</strong></li>
<li><strong>Tras el establecimiento de la VPN, la máquina cliente debe ser capaz de acceder a una máquina que esté en la otra red a la que está conectado el servidor.</strong>
<strong>Documenta el proceso detalladamente.</strong></li>
</ul>
<p>Antes que nada, tendremos que tener un escenario donde realizaremos la práctica. Crearé dos instancias en OpenStack, y el equipo servidor estará conectado a 2 redes distintas.</p>
<p><img src="/img/SAD-P6.1.png" alt="SAD-P6.1.png"></p>
<p>Una vez creado el escenario, empezaremos con la práctica.</p>
<h5 id="configuraci%C3%B3n-del-servidor." tabindex="-1">Configuración del servidor.</h5>
<p>Lo primero que haremos será instalar openvpn.</p>
<p><img src="/img/SAD-P6.2.png" alt="SAD-P6.2.png"></p>
<p>Ahora, activaremos el bit de forwarding en el servidor.</p>
<pre class="language-txt"><code class="language-txt">root@servidor-vpn:~$  nano /etc/sysctl.conf</code></pre>
<p>editamos la siguiente línea:</p>
<pre class="language-txt"><code class="language-txt"># Uncomment the next line to enable packet forwarding for IPv4<br>net.ipv4.ip_forward=1</code></pre>
<p>Por precaución, copiaremos la configuración que se encuentra en <code>/usr/share/easy-rsa</code> a <code>/etc/openvpn</code> para evitar que en una próxima actualización del paquete sobreescriba los cambios que hagamos:</p>
<pre class="language-txt"><code class="language-txt">root@servidor-vpn:~$  cp -r /usr/share/easy-rsa /etc/openvpn</code></pre>
<p>Ahora dentro del directorio <code>/etc/openvpn/easy-rsa/</code>, ejecutaremos el siguiente script para inicializar el directorio PKI:</p>
<pre class="language-txt"><code class="language-txt">root@servidor-vpn:/etc/openvpn/easy-rsa# ./easyrsa init-pki<br><br>init-pki complete; you may now create a CA or requests.<br>Your newly created PKI dir is: /etc/openvpn/easy-rsa/pki<br><br><br></code></pre>
<p>A continuación, vamos a generar el certificado de la CA y la clave con la que firmaremos los certificados. Tendremos que introducir una contraseña para el certificado y un nombre para la autoridad certificadora.</p>
<pre class="language-txt"><code class="language-txt">root@servidor-vpn:/etc/openvpn/easy-rsa# ./easyrsa build-ca<br>Using SSL: openssl OpenSSL 1.1.1n  15 Mar 2022<br><br>Enter New CA Key Passphrase: <br>Re-Enter New CA Key Passphrase: <br>Generating RSA private key, 2048 bit long modulus (2 primes)<br>..............+++++<br>................................+++++<br>e is 65537 (0x010001)<br>You are about to be asked to enter information that will be incorporated<br>into your certificate request.<br>What you are about to enter is what is called a Distinguished Name or a DN.<br>There are quite a few fields but you can leave some blank<br>For some fields there will be a default value,<br>If you enter '.', the field will be left blank.<br>-----<br>Common Name (eg: your user, host, or server name) [Easy-RSA CA]:alejandro-montes<br><br>CA creation complete and you may now import and sign cert requests.<br>Your new CA certificate file for publishing is at:<br>/etc/openvpn/easy-rsa/pki/ca.crt</code></pre>
<p>Como indica la salida del comando, el certificado se ha generado en la ruta <code>/etc/openvpn/easy-rsa/pki/ca.crt</code> mientras que la clave privada se encuentra en <code>/etc/openvpn/easy-rsa/pki/private/ca.key</code>. Ahora tendremos que generar los parámetros Diffie-Hellman, los cuáles se usan para el intercambio de claves entre el servidor de openvpn y los clientes.</p>
<p><img src="/img/SAD-P6.3.png" alt="SAD-P6.3.png"></p>
<p>El archivo ha sido generado en el directorio <code>/etc/openvpn/easy-rsa/pki/dh.pem</code>.</p>
<p>Ahora generaremos el certificado y la clave privada del servidor openvpn:</p>
<pre class="language-txt"><code class="language-txt">root@servidor-vpn:/etc/openvpn/easy-rsa# ./easyrsa build-server-full server nopass<br>Using SSL: openssl OpenSSL 1.1.1n  15 Mar 2022<br>Generating a RSA private key<br>.........................+++++<br>.......................+++++<br>writing new private key to '/etc/openvpn/easy-rsa/pki/easy-rsa-22061.NS9Bww/tmp.gmhUC5'<br>-----<br>Using configuration from /etc/openvpn/easy-rsa/pki/easy-rsa-22061.NS9Bww/tmp.xcbWer<br>Enter pass phrase for /etc/openvpn/easy-rsa/pki/private/ca.key:<br>Check that the request matches the signature<br>Signature ok<br>The Subject's Distinguished Name is as follows<br>commonName            :ASN.1 12:'server'<br>Certificate is to be certified until Apr 17 11:03:08 2025 GMT (825 days)<br><br>Write out database with 1 new entries<br>Data Base Updated</code></pre>
<p>El certificado ha sido guardado en la ruta <code>/etc/openvpn/easy-rsa/pki/issued/server.crt</code> y la clave privada se ha generado en <code>/etc/openvpn/easy-rsa/pki/private/server.key</code>. La opción nopass es para deshabilitar la frase de paso.</p>
<p>Una vez hecho esto, generaremos el certificado y la clave privada del cliente de la vpn:</p>
<pre class="language-txt"><code class="language-txt">root@servidor-vpn:/etc/openvpn/easy-rsa# ./easyrsa build-client-full cliente-vpn nopass<br>Using SSL: openssl OpenSSL 1.1.1n  15 Mar 2022<br>Generating a RSA private key<br>.................................+++++<br>..........+++++<br>writing new private key to '/etc/openvpn/easy-rsa/pki/easy-rsa-22138.MZyJbQ/tmp.MWGIDo'<br>-----<br>Using configuration from /etc/openvpn/easy-rsa/pki/easy-rsa-22138.MZyJbQ/tmp.1G19BJ<br>Enter pass phrase for /etc/openvpn/easy-rsa/pki/private/ca.key:<br>Check that the request matches the signature<br>Signature ok<br>The Subject's Distinguished Name is as follows<br>commonName            :ASN.1 12:'cliente-vpn'<br>Certificate is to be certified until Apr 17 11:06:42 2025 GMT (825 days)<br><br>Write out database with 1 new entries<br>Data Base Updated<br><br></code></pre>
<p>El certificado esta generado en <code>etc/openvpn/easy-rsa/pki/issued/Clientevpn1.crt</code> y la clave privada en <code>/etc/openvpn/easy-rsa/pki/private/Clientevpn1.key</code>.</p>
<p>Ahora pasaremos al cliente los ficheros necesarios. Para ello, primero en el servidor crearemos una carpeta con los ficheros del cliente vpn y posteriormente lo pasaremos al cliente por scp mediante mi máquina local:</p>
<pre class="language-txt"><code class="language-txt">root@servidor-vpn:/etc/openvpn/easy-rsa# mkdir /home/debian/cliente-vpn<br>root@servidor-vpn:/etc/openvpn/easy-rsa# cp -rp /etc/openvpn/easy-rsa/pki/{ca.crt,issued/cliente-vpn.crt,private/cliente-vpn.key} /home/debian/cliente-vpn/<br>root@servidor-vpn:/etc/openvpn/easy-rsa# chown debian: /home/debian/cliente-vpn/<br>alemd@172.22.0.161's password: <br>cliente-vpn.key                           100% 1704   201.0KB/s   00:00    <br>ca.crt                                    100% 1224   138.4KB/s   00:00    <br>cliente-vpn.crt                           100% 4525   325.1KB/s   00:00   <br><br><br>alemd@debian:~$ scp -r cliente-vpn/ debian@172.22.201.177:<br>cliente-vpn.key                           100% 1704   125.8KB/s   00:00    <br>ca.crt                                    100% 1224     5.1KB/s   00:00    <br>cliente-vpn.crt                           100% 4525   329.6KB/s   00:00  </code></pre>
<p>Una vez hecho esto, desde el lado del servidor aún, crearemos el archivo de configuración del tunel que crearemos a partir del fichero de ejemplo:</p>
<pre class="language-txt"><code class="language-txt">root@servidor-vpn:/home/debian# cp /usr/share/doc/openvpn/examples/sample-config-files/server.conf /etc/openvpn/server/servidor.conf</code></pre>
<p>Lo editamos y el resultado es el siguiente:</p>
<pre class="language-txt"><code class="language-txt">root@servidor-vpn:/home/debian# nano /etc/openvpn/server/servidor.conf</code></pre>
<pre class="language-txt"><code class="language-txt"><br>port 1194<br>proto udp<br>dev tun<br><br>ca /etc/openvpn/easy-rsa/pki/ca.crt<br>cert /etc/openvpn/easy-rsa/pki/issued/server.crt<br>key /etc/openvpn/easy-rsa/pki/private/server.key  # This file should be kept<br> secret<br>dh  /etc/openvpn/easy-rsa/pki/dh.pem<br><br>topology subnet<br><br>server 10.100.200.0 255.255.255.0<br>ifconfig-pool-persist /var/log/openvpn/ipp.txt<br><br>push "route 192.168.100.0 255.255.255.0"<br><br>keepalive 10 120<br>cipher AES-256-CBC<br>persist-key<br>persist-tun<br>status /var/log/openvpn/openvpn-status.log<br>verb 3<br><br>explicit-exit-notify 1</code></pre>
<p>Ahora que hemos terminado de crear el fichero de configuración, habilitaremos el servicio:</p>
<pre class="language-txt"><code class="language-txt">root@servidor-vpn:/home/debian# systemctl enable --now openvpn-server@servidor<br>Created symlink /etc/systemd/system/multi-user.target.wants/openvpn-server@servidor.service → /lib/systemd/system/openvpn-server@.service.</code></pre>
<p>Muestro el estado del servicio:</p>
<pre class="language-txt"><code class="language-txt">root@servidor-vpn:/home/debian# systemctl status openvpn-server@servidor<br><br>● openvpn-server@servidor.service - OpenVPN service for servidor<br>     Loaded: loaded (/lib/systemd/system/openvpn-server@.service; enabled; vendor preset: enabled)<br>     Active: active (running) since Fri 2023-01-13 11:37:51 UTC; 1min 8s ago<br>       Docs: man:openvpn(8)<br>             https://community.openvpn.net/openvpn/wiki/Openvpn24ManPage<br>             https://community.openvpn.net/openvpn/wiki/HOWTO<br>   Main PID: 22260 (openvpn)<br>     Status: "Initialization Sequence Completed"<br>      Tasks: 1 (limit: 527)<br>     Memory: 988.0K<br>        CPU: 14ms<br>     CGroup: /system.slice/system-openvpn\x2dserver.slice/openvpn-server@servidor.service<br>             └─22260 /usr/sbin/openvpn --status /run/openvpn-server/status-servidor.log --status-version 2 --suppress-timestamps --config servidor.conf<br><br>Jan 13 11:37:51 servidor-vpn openvpn[22260]: net_iface_up: set tun0 up<br>Jan 13 11:37:51 servidor-vpn openvpn[22260]: net_addr_v4_add: 10.100.200.1/24 dev tun0<br>Jan 13 11:37:51 servidor-vpn openvpn[22260]: Could not determine IPv4/IPv6 protocol. Using AF_INET<br>Jan 13 11:37:51 servidor-vpn openvpn[22260]: Socket Buffers: R=[212992->212992] S=[212992->212992]<br>Jan 13 11:37:51 servidor-vpn openvpn[22260]: UDPv4 link local (bound): [AF_INET][undef]:1194<br>Jan 13 11:37:51 servidor-vpn openvpn[22260]: UDPv4 link remote: [AF_UNSPEC]<br>Jan 13 11:37:51 servidor-vpn openvpn[22260]: MULTI: multi_init called, r=256 v=256<br>Jan 13 11:37:51 servidor-vpn openvpn[22260]: IFCONFIG POOL IPv4: base=10.100.200.2 size=252<br>Jan 13 11:37:51 servidor-vpn openvpn[22260]: IFCONFIG POOL LIST<br>Jan 13 11:37:51 servidor-vpn openvpn[22260]: Initialization Sequence Completed<br></code></pre>
<h5 id="configuraci%C3%B3n-del-cliente-vpn." tabindex="-1">Configuración del cliente VPN.</h5>
<p>Ahora tomaremos el control del cliente e instalaremos openvpn:</p>
<pre class="language-txt"><code class="language-txt">debian@cliente-vpn:~$ sudo apt install openvpn<br>Reading package lists... Done<br>Building dependency tree... Done<br>Reading state information... Done<br>The following additional packages will be installed:<br>  easy-rsa libccid liblzo2-2 libpcsclite1 libpkcs11-helper1 libusb-1.0-0<br>  opensc opensc-pkcs11 pcscd<br>Suggested packages:<br>  pcmciautils openvpn-systemd-resolved<br>The following NEW packages will be installed:<br>  easy-rsa libccid liblzo2-2 libpcsclite1 libpkcs11-helper1 libusb-1.0-0<br>  opensc opensc-pkcs11 openvpn pcscd<br>0 upgraded, 10 newly installed, 0 to remove and 0 not upgraded.<br>Need to get 2551 kB of archives.<br>After this operation, 7667 kB of additional disk space will be used.<br>Do you want to continue? [Y/n] y</code></pre>
<p>Movemos el contenido del directorio que nos hemos pasado anteriormente por scp:</p>
<pre class="language-txt"><code class="language-txt">root@cliente-vpn:/home/debian# mv cliente-vpn/* /etc/openvpn/client/</code></pre>
<p>Le cambiamos el propietario a root a los archivos que hemos movido:</p>
<pre class="language-txt"><code class="language-txt">root@cliente-vpn:/home/debian# chown root: /etc/openvpn/client/*</code></pre>
<p>Creamos el siguiente archivo:</p>
<pre class="language-txt"><code class="language-txt">root@cliente-vpn:/home/debian# nano /etc/openvpn/client/cliente.conf</code></pre>
<p>Le añadimos lo siguiente:</p>
<pre class="language-txt"><code class="language-txt">client<br>dev tun<br>proto udp<br><br>remote 10.0.0.15 1194<br>resolv-retry infinite<br>nobind<br>persist-key<br>persist-tun<br><br>ca /etc/openvpn/client/ca.crt<br>cert /etc/openvpn/client/cliente-vpn.crt<br>key /etc/openvpn/client/cliente-vpn.key<br><br>remote-cert-tls server<br>cipher AES-256-CBC<br>verb 3<br></code></pre>
<p>Ahora miramos si el servicio está funcionando correctamente:</p>
<pre class="language-txt"><code class="language-txt">root@cliente-vpn:/etc/openvpn/client# systemctl status openvpn-client@cliente<br>● openvpn-client@cliente.service - OpenVPN tunnel for cliente<br>     Loaded: loaded (/lib/systemd/system/openvpn-client@.service; enabled; vendor preset: enabled)<br>     Active: active (running) since Fri 2023-01-13 19:44:09 UTC; 15s ago<br>       Docs: man:openvpn(8)<br>             https://community.openvpn.net/openvpn/wiki/Openvpn24ManPage<br>             https://community.openvpn.net/openvpn/wiki/HOWTO<br>   Main PID: 22514 (openvpn)<br>     Status: "Initialization Sequence Completed"<br>      Tasks: 1 (limit: 527)<br>     Memory: 1004.0K<br>        CPU: 22ms<br>     CGroup: /system.slice/system-openvpn\x2dclient.slice/openvpn-client@cliente.service<br>             └─22514 /usr/sbin/openvpn --suppress-timestamps --nobind --config cliente.conf<br><br>Jan 13 19:44:09 cliente-vpn openvpn[22514]: net_route_v4_best_gw query: dst 0.0.0.0<br>Jan 13 19:44:09 cliente-vpn openvpn[22514]: net_route_v4_best_gw result: via 10.0.0.1 dev ens3<br>Jan 13 19:44:09 cliente-vpn openvpn[22514]: ROUTE_GATEWAY 10.0.0.1/255.255.255.0 IFACE=ens3 HWADDR=fa:16:3e:7a:78:88<br>Jan 13 19:44:10 cliente-vpn openvpn[22514]: TUN/TAP device tun0 opened<br>Jan 13 19:44:10 cliente-vpn openvpn[22514]: net_iface_mtu_set: mtu 1500 for tun0<br>Jan 13 19:44:10 cliente-vpn openvpn[22514]: net_iface_up: set tun0 up<br>Jan 13 19:44:10 cliente-vpn openvpn[22514]: net_addr_v4_add: 10.100.200.2/24 dev tun0<br>Jan 13 19:44:10 cliente-vpn openvpn[22514]: net_route_v4_add: 192.168.100.0/24 via 10.100.200.1 dev [NULL] table 0 metric -1<br>Jan 13 19:44:10 cliente-vpn openvpn[22514]: WARNING: this configuration may cache passwords in memory -- use the auth-nocache option to prevent ><br>Jan 13 19:44:10 cliente-vpn openvpn[22514]: Initialization Sequence Completed</code></pre>
<p>Como podemos ver, el servicio está activo y el servidor le ha asignado una ip correctamente. Ahora mostraré las interfaces de red del cliente y veremos que se ha creado un tun0 con la dirección ip de la vpn:</p>
<pre class="language-txt"><code class="language-txt">root@cliente-vpn:/etc/openvpn/client# ip a<br>1: lo: &lt;LOOPBACK,UP,LOWER_UP> mtu 65536 qdisc noqueue state UNKNOWN group default qlen 1000<br>    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00<br>    inet 127.0.0.1/8 scope host lo<br>       valid_lft forever preferred_lft forever<br>    inet6 ::1/128 scope host <br>       valid_lft forever preferred_lft forever<br>2: ens3: &lt;BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1450 qdisc pfifo_fast state UP group default qlen 1000<br>    link/ether fa:16:3e:7a:78:88 brd ff:ff:ff:ff:ff:ff<br>    altname enp0s3<br>    inet 10.0.0.186/24 brd 10.0.0.255 scope global dynamic ens3<br>       valid_lft 68878sec preferred_lft 68878sec<br>    inet6 fe80::f816:3eff:fe7a:7888/64 scope link <br>       valid_lft forever preferred_lft forever<br>3: tun0: &lt;POINTOPOINT,MULTICAST,NOARP,UP,LOWER_UP> mtu 1500 qdisc pfifo_fast state UNKNOWN group default qlen 500<br>    link/none <br>    inet 10.100.200.2/24 scope global tun0<br>       valid_lft forever preferred_lft forever<br>    inet6 fe80::e7f5:181c:a293:e455/64 scope link stable-privacy <br>       valid_lft forever preferred_lft forever</code></pre>
<p>Ahora muestro las interfaces de red del servidor:</p>
<pre class="language-txt"><code class="language-txt">root@servidor-vpn:/home/debian# ip a<br>1: lo: &lt;LOOPBACK,UP,LOWER_UP> mtu 65536 qdisc noqueue state UNKNOWN group default qlen 1000<br>    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00<br>    inet 127.0.0.1/8 scope host lo<br>       valid_lft forever preferred_lft forever<br>    inet6 ::1/128 scope host <br>       valid_lft forever preferred_lft forever<br>2: ens3: &lt;BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1450 qdisc pfifo_fast state UP group default qlen 1000<br>    link/ether fa:16:3e:b6:d0:79 brd ff:ff:ff:ff:ff:ff<br>    altname enp0s3<br>    inet 192.168.100.66/24 brd 192.168.100.255 scope global dynamic ens3<br>       valid_lft 78208sec preferred_lft 78208sec<br>    inet6 fe80::f816:3eff:feb6:d079/64 scope link <br>       valid_lft forever preferred_lft forever<br>3: ens4: &lt;BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1450 qdisc pfifo_fast state UP group default qlen 1000<br>    link/ether fa:16:3e:23:26:50 brd ff:ff:ff:ff:ff:ff<br>    altname enp0s4<br>    inet 10.0.0.15/24 brd 10.0.0.255 scope global dynamic ens4<br>       valid_lft 83174sec preferred_lft 83174sec<br>    inet6 fe80::f816:3eff:fe23:2650/64 scope link <br>       valid_lft forever preferred_lft forever<br>4: tun0: &lt;POINTOPOINT,MULTICAST,NOARP,UP,LOWER_UP> mtu 1500 qdisc pfifo_fast state UNKNOWN group default qlen 500<br>    link/none <br>    inet 10.100.200.1/24 scope global tun0<br>       valid_lft forever preferred_lft forever<br>    inet6 fe80::c656:fa09:7f9c:ffb4/64 scope link stable-privacy <br>       valid_lft forever preferred_lft forever</code></pre>
<p>Ahora añadiremos un cliente conectado a la red de la vpn. Añadiremos una ruta estática por defecto para que use el servidor:</p>
<pre class="language-txt"><code class="language-txt">ip route del default<br>ip route add default via 192.168.11.10</code></pre>
<p><strong>Atención he vuelto a hacer el escenario en Vagrant ya que en OpenStack da problemas al cambiar las rutas estáticas de la máquina.</strong></p>
<p>Hay que remarcar que en el servidor tenemos que añadir una regla de encaminamiento desde la red de la vpn a la red con la que queremos que se vea. La regla es la siguiente:</p>
<pre class="language-txt"><code class="language-txt">root@servidor-vpn:/home/vagrant# sudo iptables -A POSTROUTING -t nat -s 172.111.222.0/24 -o eth2 -j MASQUERADE</code></pre>
<p>Muestro como desde el cliente externo a la red vpn realiza ping al cliente de la vpn:</p>
<pre class="language-txt"><code class="language-txt">vagrant@clientevpn:~$ ping 172.111.222.2<br>PING 172.111.222.2 (172.111.222.2) 56(84) bytes of data.<br>64 bytes from 172.111.222.2: icmp_seq=1 ttl=63 time=1.70 ms<br>64 bytes from 172.111.222.2: icmp_seq=2 ttl=63 time=3.05 ms<br>64 bytes from 172.111.222.2: icmp_seq=3 ttl=63 time=2.35 ms<br>64 bytes from 172.111.222.2: icmp_seq=4 ttl=63 time=2.78 ms<br>64 bytes from 172.111.222.2: icmp_seq=5 ttl=63 time=2.72 ms</code></pre>
<p>Ahora muestro un traceroute:</p>
<pre class="language-txt"><code class="language-txt">vagrant@clientevpn:~$ traceroute 172.111.222.2<br>traceroute to 172.111.222.2 (172.111.222.2), 30 hops max, 60 byte packets<br> 1  10.100.200.1 (10.100.200.1)  0.349 ms  0.267 ms  0.306 ms<br> 2  172.111.222.2 (172.111.222.2)  2.544 ms  2.526 ms  2.547 ms</code></pre>
<p>Ahora desde el cliente de la vpn hago ping y un traceroute al cliente externo a la vpn:</p>
<pre class="language-txt"><code class="language-txt">vagrant@clientevpn:~$ ping 10.100.200.10<br>PING 10.100.200.10 (10.100.200.10) 56(84) bytes of data.<br>64 bytes from 10.100.200.10: icmp_seq=1 ttl=63 time=3.63 ms<br>64 bytes from 10.100.200.10: icmp_seq=2 ttl=63 time=2.50 ms<br>64 bytes from 10.100.200.10: icmp_seq=3 ttl=63 time=3.00 ms<br>64 bytes from 10.100.200.10: icmp_seq=4 ttl=63 time=3.08 ms<br>^C<br>--- 10.100.200.10 ping statistics ---<br>4 packets transmitted, 4 received, 0% packet loss, time 3005ms<br>rtt min/avg/max/mdev = 2.497/3.053/3.633/0.402 ms<br>vagrant@clientevpn:~$ traceroute 10.100.200.10<br>traceroute to 10.100.200.10 (10.100.200.10), 30 hops max, 60 byte packets<br> 1  172.111.222.1 (172.111.222.1)  1.059 ms  0.955 ms  0.904 ms<br> 2  10.100.200.10 (10.100.200.10)  1.773 ms  1.640 ms  2.039 ms<br></code></pre>
<h4 id="1.2.-vpn-sitio-a-sitio-con-openvpn-y-certificados-x509.-(10-puntos)" tabindex="-1">1.2. VPN sitio a sitio con OpenVPN y certificados x509. (10 puntos)</h4>
<p><strong>Configura una conexión VPN sitio a sitio entre dos equipos del cloud:</strong></p>
<ul>
<li><strong>Cada equipo estará conectado a dos redes, una de ellas en común.</strong></li>
<li><strong>Para la autenticación de los extremos se usarán obligatoriamente certificados digitales, que se generarán utilizando openssl y se almacenarán en el directorio /etc/openvpn, junto con con los parámetros Diffie-Helman y el certificado de la propia Autoridad de Certificación.</strong></li>
<li><strong>Se utilizarán direcciones de la red 10.99.99.0/24 para las direcciones virtuales de la VPN.</strong></li>
<li><strong>Tras el establecimiento de la VPN, una máquina de cada red detrás de cada servidor VPN debe ser capaz de acceder a una máquina del otro extremo.</strong>
<strong>Documenta el proceso detalladamente.</strong></li>
</ul>
<p>En este apartado, necesitaremos dos clientes y dos servidores y tendremos que conectar los servidores a través de una vpn. Adjunto un esquema lógico para que se vea más claro:</p>
<p><img src="/img/site2site.png" alt="site2site.png"></p>
<p>El escenario será realizado en Vagrant. Adjunto el Vagrantfile con el escenario completo:</p>
<pre class="language-txt"><code class="language-txt">Vagrant.configure("2") do |config|<br><br>    config.vm.define :nodo1 do |nodo1|<br>      nodo1.vm.box = "debian/bullseye64"<br>      nodo1.vm.hostname = "servidor-vpn"<br>      nodo1.vm.synced_folder ".", "/vagrant", disabled: true<br>      nodo1.vm.network :private_network,<br>      :libvirt__network_name => "net1",<br>      :libvirt__dhcp_enabled => false,<br>      :ip => "10.0.0.10",<br>      :libvirt__forward_mode => "veryisolated"<br>    end<br>  config.vm.define :nodo2 do |nodo2|<br>    nodo2.vm.box = "debian/bullseye64"<br>    nodo2.vm.hostname = "clientevpn"<br>    nodo2.vm.synced_folder ".", "/vagrant", disabled: true<br>    nodo2.vm.network :private_network,<br>      :libvirt__network_name => "net1",<br>      :libvirt__dhcp_enabled => false,<br>      :ip => "10.0.0.11",<br>      :libvirt__forward_mode => "veryisolated"<br>    end<br>   config.vm.define :nodo3 do |nodo3|<br>     nodo3.vm.box = "debian/bullseye64"<br>     nodo3.vm.hostname = "servidor2-vpn"<br>     nodo3.vm.synced_folder ".", "/vagrant", disabled: true      <br>     nodo3.vm.network :private_network,<br>      :libvirt__network_name => "net2",<br>      :libvirt__dhcp_enabled => false,<br>      :ip => "10.1.2.1",<br>      :libvirt__forward_mode => "veryisolated"<br>    end<br>  config.vm.define :nodo4 do |nodo4|<br>    nodo4.vm.box = "debian/bullseye64"<br>    nodo4.vm.hostname = "cliente2vpn"<br>    nodo4.vm.synced_folder ".", "/vagrant", disabled: true<br>    nodo4.vm.network :private_network,<br>      :libvirt__network_name => "net2",<br>      :libvirt__dhcp_enabled => false,<br>      :ip => "10.1.2.2",<br>      :libvirt__forward_mode => "veryisolated"<br>    end<br>  end</code></pre>
<p>Como podemos ver, son dos servidores totalmente aislados con un cliente cada uno y lo que haremos será configurar una vpn para que ambas redes sean visibles entre sí.</p>
<h5 id="configuraci%C3%B3n-del-servidor1." tabindex="-1">Configuración del servidor1.</h5>
<p>Lo primero que haremos, será instalar openvpn y configurar un fichero llamado vars, cogeremos de ejemplo un fichero que se encontrará en el mismo directorio:</p>
<pre class="language-txt"><code class="language-txt">vagrant@servidor-vpn:~$ sudo apt install openvpn<br>Reading package lists... Done<br>Building dependency tree... Done<br>Reading state information... Done<br>The following additional packages will be installed:<br>  easy-rsa libccid liblzo2-2 libpcsclite1 libpkcs11-helper1 libusb-1.0-0<br>  opensc opensc-pkcs11 pcscd<br>Suggested packages:<br>  pcmciautils resolvconf openvpn-systemd-resolved<br>The following NEW packages will be installed:<br>  easy-rsa libccid liblzo2-2 libpcsclite1 libpkcs11-helper1 libusb-1.0-0<br>  opensc opensc-pkcs11 openvpn pcscd<br>0 upgraded, 10 newly installed, 0 to remove and 31 not upgraded.<br>Need to get 2551 kB of archives.<br>After this operation, 7667 kB of additional disk space will be used.<br>Do you want to continue? [Y/n] y<br>vagrant@servidor-vpn:~$ cd /usr/share/easy-rsa/<br>vagrant@servidor-vpn:/usr/share/easy-rsa$ sudo su<br>root@servidor-vpn:/usr/share/easy-rsa# cp vars.example vars<br>root@servidor-vpn:/usr/share/easy-rsa# nano vars</code></pre>
<p>El archivo vars contiene lo siguiente:</p>
<pre class="language-txt"><code class="language-txt">set_var EASYRSA_REQ_COUNTRY     "ES"<br>set_var EASYRSA_REQ_PROVINCE    "Sevilla"<br>set_var EASYRSA_REQ_CITY        "Utrera"<br>set_var EASYRSA_REQ_ORG         "amontes"<br>set_var EASYRSA_REQ_EMAIL       "aaleemd11@gmail.com"<br>set_var EASYRSA_REQ_OU          "Practica VPN"</code></pre>
<p>Ahora crearemos el directorio donde se almacenaran los documentos de la CA:</p>
<pre class="language-txt"><code class="language-txt">root@servidor-vpn:/usr/share/easy-rsa# ./easyrsa init-pki<br><br>Note: using Easy-RSA configuration from: /usr/share/easy-rsa/vars<br><br>init-pki complete; you may now create a CA or requests.<br>Your newly created PKI dir is: /usr/share/easy-rsa/pki<br><br></code></pre>
<p>Ahora crearemos una clave Diffie-Hellman:</p>
<pre class="language-txt"><code class="language-txt">root@servidor-vpn:/usr/share/easy-rsa# ./easyrsa gen-dh<br><br>Note: using Easy-RSA configuration from: /usr/share/easy-rsa/vars<br>Using SSL: openssl OpenSSL 1.1.1n  15 Mar 2022<br>Generating DH parameters, 2048 bit long safe prime, generator 2<br>This is going to take a long time<br>........................+............................................................+....+..............................+.............................................................................................+..............................................+...........................................................................................................................................................................................................................+...................................<br><br>DH parameters of size 2048 created at /usr/share/easy-rsa/pki/dh.pem<br></code></pre>
<p>Una vez hecho esto, crearemos la CA:</p>
<pre class="language-txt"><code class="language-txt">root@servidor-vpn:/usr/share/easy-rsa# ./easyrsa build-ca<br><br>Note: using Easy-RSA configuration from: /usr/share/easy-rsa/vars<br>Using SSL: openssl OpenSSL 1.1.1n  15 Mar 2022<br><br>Enter New CA Key Passphrase: <br>Re-Enter New CA Key Passphrase: <br>Generating RSA private key, 2048 bit long modulus (2 primes)<br>.....................+++++<br>......................................+++++<br>e is 65537 (0x010001)<br>You are about to be asked to enter information that will be incorporated<br>into your certificate request.<br>What you are about to enter is what is called a Distinguished Name or a DN.<br>There are quite a few fields but you can leave some blank<br>For some fields there will be a default value,<br>If you enter '.', the field will be left blank.<br>-----<br>Common Name (eg: your user, host, or server name) [Easy-RSA CA]:Alejandro Montes<br><br>CA creation complete and you may now import and sign cert requests.<br>Your new CA certificate file for publishing is at:<br>/usr/share/easy-rsa/pki/ca.crt</code></pre>
<p>Cuando tengamos lista nuestra CA, lo primero que haremos será crear y firmar el certificado que usará nuestra máquina servidor.</p>
<pre class="language-txt"><code class="language-txt">root@servidor-vpn:/usr/share/easy-rsa# ./easyrsa gen-req server<br><br>Note: using Easy-RSA configuration from: /usr/share/easy-rsa/vars<br>Using SSL: openssl OpenSSL 1.1.1n  15 Mar 2022<br>Generating a RSA private key<br>..........................+++++<br>.................................................................................................+++++<br>writing new private key to '/usr/share/easy-rsa/pki/easy-rsa-613.56pi8H/tmp.zJd9ro'<br>Enter PEM pass phrase:<br>Verifying - Enter PEM pass phrase:<br>-----<br>You are about to be asked to enter information that will be incorporated<br>into your certificate request.<br>What you are about to enter is what is called a Distinguished Name or a DN.<br>There are quite a few fields but you can leave some blank<br>For some fields there will be a default value,<br>If you enter '.', the field will be left blank.<br>-----<br>Common Name (eg: your user, host, or server name) [server]:Alejandro Montes<br><br>Keypair and certificate request completed. Your files are:<br>req: /usr/share/easy-rsa/pki/reqs/server.req<br>key: /usr/share/easy-rsa/pki/private/server.key</code></pre>
<p>Ahora firmamos el certificado:</p>
<pre class="language-txt"><code class="language-txt">root@servidor-vpn:/usr/share/easy-rsa# ./easyrsa sign-req server server<br><br>Note: using Easy-RSA configuration from: /usr/share/easy-rsa/vars<br>Using SSL: openssl OpenSSL 1.1.1n  15 Mar 2022<br><br><br>You are about to sign the following certificate.<br>Please check over the details shown below for accuracy. Note that this request<br>has not been cryptographically verified. Please be sure it came from a trusted<br>source or that you have verified the request checksum with the sender.<br><br>Request subject, to be signed as a server certificate for 825 days:<br><br>subject=<br>    commonName                = Alejandro Montes<br><br><br>Type the word 'yes' to continue, or any other input to abort.<br>  Confirm request details: yes<br>Using configuration from /usr/share/easy-rsa/pki/easy-rsa-635.4wZS7o/tmp.l26dgD<br>Enter pass phrase for /usr/share/easy-rsa/pki/private/ca.key:<br>Check that the request matches the signature<br>Signature ok<br>The Subject's Distinguished Name is as follows<br>commonName            :ASN.1 12:'Alejandro Montes'<br>Certificate is to be certified until Apr 29 09:05:56 2025 GMT (825 days)<br><br>Write out database with 1 new entries<br>Data Base Updated<br><br>Certificate created at: /usr/share/easy-rsa/pki/issued/server.crt</code></pre>
<p>Tras crear y firmar el certificado, crearemos y firmaremos el certificado que usará el servidor2.:</p>
<pre class="language-txt"><code class="language-txt">root@servidor-vpn:/usr/share/easy-rsa# ./easyrsa gen-req vpn_server2<br><br>Note: using Easy-RSA configuration from: /usr/share/easy-rsa/vars<br>Using SSL: openssl OpenSSL 1.1.1n  15 Mar 2022<br>Generating a RSA private key<br>.....+++++<br>.............................................+++++<br>writing new private key to '/usr/share/easy-rsa/pki/easy-rsa-698.V9av96/tmp.uT7ClE'<br>Enter PEM pass phrase:<br>Verifying - Enter PEM pass phrase:<br>-----<br>You are about to be asked to enter information that will be incorporated<br>into your certificate request.<br>What you are about to enter is what is called a Distinguished Name or a DN.<br>There are quite a few fields but you can leave some blank<br>For some fields there will be a default value,<br>If you enter '.', the field will be left blank.<br>-----<br>Common Name (eg: your user, host, or server name) [vpn_server2]:Servidor 2<br><br>Keypair and certificate request completed. Your files are:<br>req: /usr/share/easy-rsa/pki/reqs/vpn_server2.req<br>key: /usr/share/easy-rsa/pki/private/vpn_server2.key<br></code></pre>
<p>Y lo firmamos:</p>
<pre class="language-txt"><code class="language-txt">root@servidor-vpn:/usr/share/easy-rsa# ./easyrsa sign-req client vpn_server2<br><br>Note: using Easy-RSA configuration from: /usr/share/easy-rsa/vars<br>Using SSL: openssl OpenSSL 1.1.1n  15 Mar 2022<br><br><br>You are about to sign the following certificate.<br>Please check over the details shown below for accuracy. Note that this request<br>has not been cryptographically verified. Please be sure it came from a trusted<br>source or that you have verified the request checksum with the sender.<br><br>Request subject, to be signed as a client certificate for 825 days:<br><br>subject=<br>    commonName                = Servidor 2<br><br><br>Type the word 'yes' to continue, or any other input to abort.<br>  Confirm request details: yes<br>Using configuration from /usr/share/easy-rsa/pki/easy-rsa-747.Dd9qde/tmp.YOHohQ<br>Enter pass phrase for /usr/share/easy-rsa/pki/private/ca.key:<br>Check that the request matches the signature<br>Signature ok<br>The Subject's Distinguished Name is as follows<br>commonName            :ASN.1 12:'Servidor 2'<br>Certificate is to be certified until Apr 29 09:10:37 2025 GMT (825 days)<br><br>Write out database with 1 new entries<br>Data Base Updated<br><br>Certificate created at: /usr/share/easy-rsa/pki/issued/vpn_server2.crt</code></pre>
<p>Ahora copiaremos los ficheros a la ruta <code>/etc/openvpn</code> para que funcione el servidor:</p>
<pre class="language-txt"><code class="language-txt">root@servidor-vpn:/usr/share/easy-rsa/pki# cp ca.crt /etc/openvpn/server/<br>root@servidor-vpn:/usr/share/easy-rsa/pki# cp dh.pem /etc/openvpn/server/<br>root@servidor-vpn:/usr/share/easy-rsa/pki# cp issued/server.crt /etc/openvpn/server/<br>root@servidor-vpn:/usr/share/easy-rsa/pki# cp private/server.key /etc/openvpn/server/</code></pre>
<p>Ahora pasamos al otro servidor los archivos necesarios para que se conecte al servidor vpn:</p>
<pre class="language-txt"><code class="language-txt">root@servidor-vpn:/usr/share/easy-rsa# scp pki/ca.crt vagrant@192.168.121.252:<br>ca.crt                                  100% 1224   672.0KB/s   00:00    <br>root@servidor-vpn:/usr/share/easy-rsa# scp pki/issued/vpn_server2.crt vagrant@192.168.121.252:<br>vpn_server2.crt                         100% 4527   134.1KB/s   00:00    <br>root@servidor-vpn:/usr/share/easy-rsa# scp pki/private/vpn_server2.key vagrant@192.168.121.252:<br>vpn_server2.key    </code></pre>
<p>Una vez hayamos pasados los archivos al otro servidor y hayamos copiado los ficheros a su ruta correspondiente, crearemos el fichero de configuración del servidor vpn.</p>
<pre class="language-txt"><code class="language-txt">dev tun<br>ifconfig 100.0.123.1 100.0.123.2<br>route 10.1.2.0 255.255.255.0<br>tls-server<br>ca ca.crt<br>cert server.crt<br>key server.key<br>dh dh.pem<br>comp-lzo<br>keepalive 10 120<br>log /var/log/openvpn/server.log<br>verb 3<br>askpass passwd.txt</code></pre>
<p>Creamos en /etc/openvpn/server un fichero llamado passwd.txt con la contraseña de frase de paso que hemos introducido anteriormente.</p>
<p>Iniciamos el servidor vpn:</p>
<pre class="language-txt"><code class="language-txt">root@servidor-vpn:/etc/openvpn/server# systemctl start openvpn-server@servidor</code></pre>
<p>Ahora hacemos un status para ver que se ha iniciado correctamente:</p>
<pre class="language-txt"><code class="language-txt">● openvpn-server@servidor.service - OpenVPN service for servidor<br>     Loaded: loaded (/lib/systemd/system/openvpn-server@.service; disable><br>     Active: active (running) since Wed 2023-01-25 12:21:45 UTC; 39s ago<br>       Docs: man:openvpn(8)<br>             https://community.openvpn.net/openvpn/wiki/Openvpn24ManPage<br>             https://community.openvpn.net/openvpn/wiki/HOWTO<br>   Main PID: 11960 (openvpn)<br>     Status: "Pre-connection initialization successful"<br>      Tasks: 1 (limit: 527)<br>     Memory: 936.0K<br>        CPU: 27ms<br>     CGroup: /system.slice/system-openvpn\x2dserver.slice/openvpn-server@><br>             └─11960 /usr/sbin/openvpn --status /run/openvpn-server/statu><br><br>Jan 25 12:21:44 servidor-vpn systemd[1]: Starting OpenVPN service for ser><br>Jan 25 12:21:45 servidor-vpn openvpn[11960]: WARNING: Compression for rec><br>Jan 25 12:21:45 servidor-vpn systemd[1]: Started OpenVPN service for serv></code></pre>
<p>Si no lo hemos hecho antes, activamos el bit de forwarding a 1:</p>
<pre class="language-txt"><code class="language-txt">root@servidor-vpn:/etc/openvpn/server# echo 1 > /proc/sys/net/ipv4/ip_forward</code></pre>
<h5 id="configuraci%C3%B3n-del-cliente1." tabindex="-1">Configuración del cliente1.</h5>
<p>Cambiaremos la ruta por defecto del cliente1:</p>
<pre class="language-txt"><code class="language-txt">vagrant@clientevpn:~$ sudo ip r del default<br>vagrant@clientevpn:~$ sudo ip r add default via 10.0.0.10<br></code></pre>
<pre class="language-txt"><code class="language-txt"></code></pre>
<h5 id="configuraci%C3%B3n-del-servidor2" tabindex="-1">Configuración del servidor2</h5>
<p>Ahora configuraremos el servidor 2 que es el otro extremo del túnel vpn. Lo primero que haremos será instalar openvpn y mover los ficheros que pasamos anteriormente por scp a las rutas adecuadas:</p>
<pre class="language-txt"><code class="language-txt">vagrant@servidor2-vpn:~$ sudo apt install openvpn<br>Reading package lists... Done<br>Building dependency tree... Done<br>Reading state information... Done<br>The following additional packages will be installed:<br>  easy-rsa libccid liblzo2-2 libpcsclite1 libpkcs11-helper1 libusb-1.0-0<br>  opensc opensc-pkcs11 pcscd<br>Suggested packages:<br>  pcmciautils resolvconf openvpn-systemd-resolved<br>The following NEW packages will be installed:<br>  easy-rsa libccid liblzo2-2 libpcsclite1 libpkcs11-helper1 libusb-1.0-0<br>  opensc opensc-pkcs11 openvpn pcscd<br>0 upgraded, 10 newly installed, 0 to remove and 0 not upgraded.<br>Need to get 2551 kB of archives.<br>After this operation, 7667 kB of additional disk space will be used.<br>Do you want to continue? [Y/n] y<br>vagrant@servidor2-vpn:~$ sudo su<br>root@servidor2-vpn:/home/vagrant# mv ca.crt /etc/openvpn/client/<br>root@servidor2-vpn:/home/vagrant# mv vpn_server2.crt /etc/openvpn/client/<br>root@servidor2-vpn:/home/vagrant# mv vpn_server2.key /etc/openvpn/client/</code></pre>
<p>Creamos un archivo de configuración para este servidor:</p>
<pre class="language-txt"><code class="language-txt">root@servidor2-vpn:/home/vagrant# nano /etc/openvpn/client/client.conf</code></pre>
<pre class="language-txt"><code class="language-txt">dev tun<br>remote 192.168.121.6<br>ifconfig 100.0.123.2 100.0.123.1<br>route 10.0.0.0 255.255.255.0<br>tls-client<br>ca ca.crt<br>cert vpn_server2.crt<br>key vpn_server2.key<br>comp-lzo<br>keepalive 10 60<br>verb 3<br>askpass passwd2.txt</code></pre>
<p>Ahora arrancamos el servicio:</p>
<pre class="language-txt"><code class="language-txt">root@servidor2-vpn:/etc/openvpn/client# systemctl start openvpn-client@client</code></pre>
<p>Muestro el estado del servicio:</p>
<pre class="language-txt"><code class="language-txt">openvpn-client@client.service - OpenVPN tunnel for client<br>     Loaded: loaded (/lib/systemd/system/openvpn-client@.service; disable><br>     Active: active (running) since Wed 2023-01-25 14:25:56 UTC; 2min 14s><br>       Docs: man:openvpn(8)<br>             https://community.openvpn.net/openvpn/wiki/Openvpn24ManPage<br>             https://community.openvpn.net/openvpn/wiki/HOWTO<br>   Main PID: 12472 (openvpn)<br>     Status: "Pre-connection initialization successful"<br>      Tasks: 1 (limit: 527)<br>     Memory: 1.1M<br>        CPU: 50ms<br>     CGroup: /system.slice/system-openvpn\x2dclient.slice/openvpn-client@><br>             └─12472 /usr/sbin/openvpn --suppress-timestamps --nobind --c><br><br>Jan 25 14:28:06 servidor2-vpn openvpn[12472]: ROUTE_GATEWAY 192.168.121.1><br>Jan 25 14:28:06 servidor2-vpn openvpn[12472]: TUN/TAP device tun0 opened<br>Jan 25 14:28:06 servidor2-vpn openvpn[12472]: net_iface_mtu_set: mtu 1500><br>Jan 25 14:28:06 servidor2-vpn openvpn[12472]: net_iface_up: set tun0 up<br>Jan 25 14:28:06 servidor2-vpn openvpn[12472]: net_addr_ptp_v4_add: 100.0.><br>Jan 25 14:28:06 servidor2-vpn openvpn[12472]: net_route_v4_add: 10.0.0.0/><br>Jan 25 14:28:06 servidor2-vpn openvpn[12472]: TCP/UDP: Preserving recentl><br>Jan 25 14:28:06 servidor2-vpn openvpn[12472]: Socket Buffers: R=[212992->><br>Jan 25 14:28:06 servidor2-vpn openvpn[12472]: UDP link local: (not bound)<br>Jan 25 14:28:06 servidor2-vpn openvpn[12472]: UDP link remote: [AF_INET]1></code></pre>
<p>No debemos olvidarnos de activar el bit de forwarding en este servidor también:</p>
<pre class="language-txt"><code class="language-txt">echo 1 > /proc/sys/net/ipv4/ip_forward</code></pre>
<h5 id="configuraci%C3%B3n-cliente-2." tabindex="-1">Configuración cliente 2.</h5>
<p>Cambiamos la ruta por defecto del cliente2:</p>
<pre class="language-txt"><code class="language-txt">vagrant@cliente2vpn:~$ sudo ip r del default<br>vagrant@cliente2vpn:~$ sudo ip r add default via 10.1.2.1</code></pre>
<h5 id="comprobaciones." tabindex="-1">Comprobaciones.</h5>
<p>IPs:</p>
<p>Servidor1-vpn:10.0.0.10,192.168.121.6</p>
<p>Cliente1-vpn:10.0.0.11</p>
<p>Servidor2-vpn:10.1.2.1.1,192.168.121.252</p>
<p>Cliente2-vpn:10.1.2.1.2</p>
<p>Ping y traceroute desde el cliente del servidor 1 al cliente del servidor 2:</p>
<pre class="language-txt"><code class="language-txt">vagrant@clientevpn:~$ ping 10.1.2.2<br>PING 10.1.2.2 (10.1.2.2) 56(84) bytes of data.<br>64 bytes from 10.1.2.2: icmp_seq=1 ttl=62 time=3.13 ms<br>64 bytes from 10.1.2.2: icmp_seq=2 ttl=62 time=3.48 ms<br>64 bytes from 10.1.2.2: icmp_seq=3 ttl=62 time=3.55 ms<br>64 bytes from 10.1.2.2: icmp_seq=4 ttl=62 time=3.14 ms<br>^C<br>--- 10.1.2.2 ping statistics ---<br>4 packets transmitted, 4 received, 0% packet loss, time 3005ms<br>rtt min/avg/max/mdev = 3.130/3.325/3.549/0.191 ms<br>vagrant@clientevpn:~$ traceroute 10.1.2.2<br>traceroute to 10.1.2.2 (10.1.2.2), 30 hops max, 60 byte packets<br> 1  10.0.0.10 (10.0.0.10)  0.470 ms  0.414 ms  0.469 ms<br> 2  pool-100-0-123-2.bstnma.fios.verizon.net (100.0.123.2)  1.674 ms  3.207 ms  3.144 ms<br> 3  10.1.2.2 (10.1.2.2)  3.090 ms  3.072 ms  2.993 ms</code></pre>
<p>Ping y traceroute desde el cliente del servidor 2 al cliente del servidor 1:</p>
<pre class="language-txt"><code class="language-txt">vagrant@cliente2vpn:~$ ping 10.0.0.11<br>PING 10.0.0.11 (10.0.0.11) 56(84) bytes of data.<br>64 bytes from 10.0.0.11: icmp_seq=1 ttl=62 time=3.55 ms<br>64 bytes from 10.0.0.11: icmp_seq=2 ttl=62 time=3.91 ms<br>64 bytes from 10.0.0.11: icmp_seq=3 ttl=62 time=3.89 ms<br>^C<br>--- 10.0.0.11 ping statistics ---<br>3 packets transmitted, 3 received, 0% packet loss, time 2003ms<br>rtt min/avg/max/mdev = 3.551/3.782/3.910/0.163 ms<br>vagrant@cliente2vpn:~$ traceroute 10.0.0.11<br>traceroute to 10.0.0.11 (10.0.0.11), 30 hops max, 60 byte packets<br> 1  10.1.2.1 (10.1.2.1)  0.577 ms  0.532 ms  0.476 ms<br> 2  lo0-100.BSTNMA-VFTTP-306.verizon-gni.net (100.0.123.1)  2.497 ms  2.832 ms  3.371 ms<br> 3  10.0.0.11 (10.0.0.11)  3.341 ms  3.210 ms  3.121 ms</code></pre>
<h3 id="wireguard" tabindex="-1">WireGuard</h3>
<h4 id="2.1.-vpn-de-acceso-remoto-con-wireguard.-(5-puntos)" tabindex="-1">2.1. VPN de acceso remoto con WireGuard. (5 puntos)</h4>
<p><strong>Monta una VPN de acceso remoto usando Wireguard. Intenta probarla con clientes Windows, Linux y Android. Documenta el proceso adecuadamente y compáralo con el del apartado A.</strong></p>
<p>Para crear el escenario he usado este Vagrantfile:</p>
<pre class="language-txt"><code class="language-txt">Vagrant.configure("2") do |config|<br><br>    config.vm.define :nodo1 do |nodo1|<br>      nodo1.vm.box = "debian/bullseye64"<br>      nodo1.vm.hostname = "wireguard-server"<br>      nodo1.vm.synced_folder ".", "/vagrant", disabled: true<br>      nodo1.vm.network :private_network,<br>      :libvirt__network_name => "net1",<br>      :libvirt__dhcp_enabled => false,<br>      :ip => "192.168.100.1",<br>      :libvirt__forward_mode => "veryisolated"<br>      nodo1.vm.network :private_network,<br>      :libvirt__network_name => "net-privada",<br>      :libvirt__dhcp_enabled => false,<br>      :ip => "192.168.50.1",<br>      :libvirt__forward_mode => "veryisolated"<br><br>    end<br>    config.vm.define :nodo2 do |nodo2|<br>      nodo2.vm.box = "debian/bullseye64"<br>      nodo2.vm.hostname = "wireguard-client"<br>      nodo2.vm.synced_folder ".", "/vagrant", disabled: true<br>      nodo2.vm.network :private_network,<br>      :libvirt__network_name => "net3",<br>      :libvirt__dhcp_enabled => false,<br>      :ip => "192.168.100.2",<br>      :libvirt__forward_mode => "veryisolated"<br>    end<br>    config.vm.define :nodo3 do |nodo3|<br>      nodo3.vm.box = "debian/bullseye64"<br>      nodo3.vm.hostname = "private-client"<br>      nodo3.vm.synced_folder ".", "/vagrant", disabled: true<br>      nodo3.vm.network :private_network,<br>      :libvirt__network_name => "net-privada",<br>      :libvirt__dhcp_enabled => false,<br>      :ip => "192.168.50.10",<br>      :libvirt__forward_mode => "veryisolated"<br>    end<br>  end</code></pre>
<h5 id="configuraci%C3%B3n-del-servidor%3A" tabindex="-1">Configuración del servidor:</h5>
<p>Una vez creado el escenario, entraremos al servidor y lo configuraremos, para ello lo primero que haremos será instalar wireguard:</p>
<pre class="language-txt"><code class="language-txt">vagrant@wireguard-server:~$ sudo apt install wireguard<br>Reading package lists... Done<br>Building dependency tree... Done<br>Reading state information... Done<br>The following additional packages will be installed:<br>  wireguard-tools<br>Suggested packages:<br>  openresolv | resolvconf<br>The following NEW packages will be installed:<br>  wireguard wireguard-tools<br>0 upgraded, 2 newly installed, 0 to remove and 31 not upgraded.<br>Need to get 94.3 kB of archives.<br>After this operation, 344 kB of additional disk space will be used.<br>Do you want to continue? [Y/n] y</code></pre>
<p>Como he tenido problemas en el apartado anterior, lo primero que haremos será activar el bit de forwarding:</p>
<pre class="language-txt"><code class="language-txt">vagrant@wireguard-server:~$ sudo nano /etc/sysctl.conf</code></pre>
<p>Y descomentamos la línea:</p>
<pre class="language-txt"><code class="language-txt">net.ipv4.ip_forward=1</code></pre>
<p>Creamos un par de claves usando el siguiente comando:</p>
<pre class="language-txt"><code class="language-txt">vagrant@wireguard-server:~$ sudo su<br>root@wireguard-server:/home/vagrant# cd /etc/wireguard/<br>root@wireguard-server:/etc/wireguard# wg genkey | tee serverprivatekey | wg pubkey > serverpublickey</code></pre>
<p>Creamos el archivo de configuración:</p>
<pre class="language-txt"><code class="language-txt">root@wireguard-server:/etc/wireguard# nano wg0.conf</code></pre>
<pre class="language-txt"><code class="language-txt">[Interface]<br>Address = 10.0.100.1 #IP de la nueva interfaz<br>PrivateKey = yMILnmrL3ACptes5tfVdGQE7aeMRjX04t1KgOF811W8= #Clave privada generada anteriormente.<br>ListenPort = 51820 #Puerto de escucha.</code></pre>
<p>Levantamos la interfaz creada con el siguiente comando:</p>
<pre class="language-txt"><code class="language-txt">root@wireguard-server:/etc/wireguard# wg-quick up wg0<br>[#] ip link add wg0 type wireguard<br>[#] wg setconf wg0 /dev/fd/63<br>[#] ip -4 address add 10.0.100.1 dev wg0<br>[#] ip link set mtu 1420 up dev wg0</code></pre>
<p>Como vemos con el siguiente comanfo, la interfaz está activa:</p>
<pre class="language-txt"><code class="language-txt">root@wireguard-server:/etc/wireguard# wg<br>interface: wg0<br>  public key: bEnc2dZ0wBF6R3GBNmeGWidnyng+w4I2QZNFqFA2emA=<br>  private key: (hidden)<br>  listening port: 51820</code></pre>
<p>Ahora que el servidor ya está configurado, procederemos a configurar los clientes:</p>
<h5 id="configuraci%C3%B3n-cliente-debian." tabindex="-1">Configuración cliente debian.</h5>
<p>Instalamos wireguard y creamos el par de claves:</p>
<pre class="language-txt"><code class="language-txt">vagrant@wireguard-client:~$ sudo apt install wireguard<br>vagrant@wireguard-client:~$ sudo su<br>cdroot@wireguard-client:/home/vagrant# cd /etc/wireguard/<br>root@wireguard-client:/etc/wireguard# wg genkey | tee clientprivatekey | wg pubkey > clientpublickey</code></pre>
<p>Creamos el fichero de configuración:</p>
<pre class="language-txt"><code class="language-txt">root@wireguard-client:/etc/wireguard# nano wg0.conf<br><br>[Interface]<br>Address = 10.0.100.2<br>PrivateKey = kDCxFoW5x4U41A826+d1l8k6J1frGKHYk5PsK2A7Y2k=<br>ListenPort = 51820<br><br>[Peer]<br>PublicKey = bEnc2dZ0wBF6R3GBNmeGWidnyng+w4I2QZNFqFA2emA=<br>AllowedIPs = 0.0.0.0/0<br>Endpoint = 192.168.100.1:51820</code></pre>
<p>Ahora del lado del servidor editamos la configuración y añadimos un bloque peer:</p>
<h4 id="2.2.-vpn-sitio-a-sitio-con-wireguard.-(10-puntos)" tabindex="-1">2.2. VPN sitio a sitio con WireGuard. (10 puntos)</h4>
<p><strong>Configura una VPN sitio a sitio usando WireGuard. Documenta el proceso adecuadamente y compáralo con el del apartado B.</strong></p>
<hr>
<h2 id="documento-realizado-por%3A" tabindex="-1"><strong>Documento realizado por:</strong></h2>
<p>✒️ <strong>Alejandro Montes Delgado</strong> - <em>2º ASIR</em></p>

        </div>
            <p class="uppercase text-xs mt-6">Siguiente post</p>
            <p class="font-bold mb-2">
                <a href="/post/servidores-web-base-de-datos-y-dns-en-nuestros-escenario-de-openstack/">Servidores Web, Base de Datos y DNS en nuestros escenario de OpenStack</a>
            </p>
        
            <p class="uppercase text-xs mt-6">Post anterior.</p>

            <p class="font-bold">
                <a href="/post/criptografia-iii.-certificados-digitales.-https./">Criptografía III. Certificados Digitales. HTTPS.</a>
            </p>
        
    </div>

    </main>
    <footer class="bg-gray-900 pb-10">
  <p class="block text-center text-sm mb-6">
    Built by
    <a target="_blank" href="https://github.com/reeseschultz">
      Reese Schultz
    </a>
  </p>

  <a class="block text-center text-sm" href="/privacy-policy">Privacy Policy</a>
</footer>
    <script src="https://unpkg.com/clipboard@2/dist/clipboard.min.js"></script>
    <script src="/assets/main.bundle.js"></script>
  </body>
</html>
