<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">

    
    <meta itemprop="name" content="Práctica: Implantación de aplicaciones web PHP en docker. | Cutreblog">
    <meta itemprop="description" content="Práctica 1 de docker.">

    
    <meta name="twitter:title" content="Práctica: Implantación de aplicaciones web PHP en docker. | Cutreblog">
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:description" content="Práctica 1 de docker.">
    <meta name="twitter:site" content="@ReeseCodes">
    <meta name="twitter:creator" content="@ReeseCodes">
    <meta name="twitter:image:src" content="https://reeseschultz.github.io/twitter.jpg">

    
    <meta name="og:title" content="Práctica: Implantación de aplicaciones web PHP en docker. | Cutreblog">
    <meta name="og:description" content="Práctica 1 de docker.">
    <meta name="og:image" content="https://reeseschultz.github.io/og.jpg">
    <meta name="og:url" content="https://reeseschultz.github.io/">
    <meta name="og:site_name" content="Cutreblog">
    <meta name="og:locale" content="en_GB">
    <meta name="og:type" content="website">

    <link rel="icon" type="image/x-icon" href="/logo.png" />

    <title>Práctica: Implantación de aplicaciones web PHP en docker. | Cutreblog</title>

    <link rel="stylesheet" href="/assets/main.bundle.css">

    
  </head>
  <body class="flex flex-col min-h-screen">
    <header>
  <nav class="container mx-auto max-w-3xl px-8 pt-2 flex flex-wrap justify-between">
    <div>
      <h1>
        <a href="/">Cutreblog</a>
      </h1>
      <p>Blog de Alejandro Montes</p>
    </div>

    <ul class="flex flex-wrap sm:w-32 w-full mt-6 md:justify-between justify-evenly">
      <li>
        <a href="/404.html">404</a>
      </li>

      <li>
        <a href="/about">Sobre mí.</a>
      </li>
    </ul>
  </nav>
</header>

    <main class="container mx-auto max-w-3xl p-8 grow">
      
    <p></p>
    <div>
        <h2>Práctica: Implantación de aplicaciones web PHP en docker.</h2>

        
            <p class="excerpt">Práctica 1 de docker.</p>
        

        
            <div class="mb-2">
                <a class="tag IAW" href="/tag/IAW">IAW</a>
            </div>
        

        
            
                <p class="text-sm italic">Creado en
                    <span datetime="Thu Feb 16 2023 01:00:00 GMT+0100 (hora estándar de Europa central)">February 16, 2023</span>.</p>
            
        

        <div class="content post">
            
                <hr />

                <h3>Tabla de Contenido.</h3>

                <nav class="toc">
                <ol>
                    
                    <li><a href="#creaci%C3%B3n-de-una-imagen-docker-con-una-aplicaci%C3%B3n-web-desde-una-imagen-base.">Creación de una imagen docker con una aplicación web desde una imagen base.</a>
            		</li>

                    <li><a href="#despliegue-en-el-entorno-de-desarrollo.">Despliegue en el entorno de desarrollo.</a>
            		</li>

                    <li><a href="#creaci%C3%B3n-de-una-imagen-docker-con-una-aplicaci%C3%B3n-web-desde-una-imagen-php.">Creación de una imagen docker con una aplicación web desde una imagen PHP.</a>
            		</li>

                    <li><a href="#ejecuci%C3%B3n-de-una-aplicaci%C3%B3n-php-en-docker-con-nginx-(optativa).">Ejecución de una aplicación PHP en docker con nginx (OPTATIVA).</a>
            		</li>

                    <li><a href="#puesta-en-producci%C3%B3n-de-nuestra-aplicaci%C3%B3n.">Puesta en producción de nuestra aplicación.</a>
            		</li>

                    <li><a href="#modificaci%C3%B3n-de-la-aplicaci%C3%B3n.">Modificación de la aplicación.</a>
            		</li>
                </ol>
            </nav>

                <hr />
            

            <p>Imaginemos que el equipo de desarrollo de nuestra empresa ha desarrollado una aplicación PHP que se llama BookMedik (<a href="https://github.com/evilnapsis/bookmedik">https://github.com/evilnapsis/bookmedik</a>).</p>
<p>Queremos crear una imagen Docker para implantar dicha aplicación.</p>
<p>Tenemos que tener en cuenta los siguientes aspectos:</p>
<p><strong>Contenedor mariadb</strong></p>
<ul>
<li>Es necesario que nuestra aplicación guarde su información en un contenedor docker mariadb.</li>
<li>El script para generar la base de datos y los registros lo encuentras en el repositorio y se llama schema.sql. Debes crear un usuario con su contraseña en la base de datos. La base de datos se llama bookmedik y se crea al ejecutar el script.</li>
<li>Ejecuta el contenedor mariadb y carga los datos del script schema.sql. Para más información.</li>
<li>El contenedor mariadb debe tener un volumen para guardar la base de datos.</li>
</ul>
<p><strong>Contenedor bookmedik</strong></p>
<ul>
<li>Vamos a crear tres versiones de la imagen que nos permite implantar la aplicación PHP.</li>
<li>La imagen debe crear las variables de entorno necesarias con datos de conexión por defecto.</li>
<li>Al crear un contenedor a partir de estas imágenes se ejecutará un script bash que realizará las siguientes tareas:
<ul>
<li>Modifique el fichero core\controller\Database.php para que lea las variables de entorno. Para obtener las variables de entorno en PHP usar la función getenv. Para más información.</li>
<li>Inicialice la base de datos con el fichero schema.sql.</li>
<li>Ejecute el servidor web.</li>
</ul>
</li>
<li>El contenedor que creas debe tener un volumen para guardar los logs del servidor web.</li>
<li>La imagen la tienes que crear en tu entorno de desarrollo con el comando docker build.</li>
</ul>
<hr>
<p>Lo primero que haremos será crear un contenedor con la imagen de mariadb con las variables de entorno que nos han indicado y crearemos una nueva red para la aplicación web.</p>
<pre class="language-txt"><code class="language-txt">usuario@debian:~/docker/practica$ docker network create red_bookmedik<br>f5873a0d59ee09ca18fed495a0cdae9b9dbd4251e926ee083c77cd906a696b86<br>usuario@debian:~/docker/practica$ docker run -d --name bd_mariadb -v bookmedik_vol:/var/lib/mysql --network red_bookmedik -e MARIADB_ROOT_PASSWORD=root -e MARIADB_DATABASE=bookmedik -e MARIADB_USER=bookmedik -e MARIADB_PASSWORD=bookmedik mariadb<br>fcc6779f9140829742d3db89892d38d5103a31902001090fb8901fd1fe690669</code></pre>
<h3 id="creaci%C3%B3n-de-una-imagen-docker-con-una-aplicaci%C3%B3n-web-desde-una-imagen-base." tabindex="-1">Creación de una imagen docker con una aplicación web desde una imagen base.</h3>
<ul>
<li><strong>Vamos a crear una imagen que se llame usuario/bookmedik:v1.</strong></li>
</ul>
<p>En primer lugar, haremos un fork al repositorio de bookmedik y lo clonaremos a nuestro equipo. Editaremos el fichero schema.sql y quitaremos las siguientes líneas:</p>
<pre class="language-txt"><code class="language-txt">create database bookmedik;<br>use bookmedik;</code></pre>
<p>Ahora, modificaremos el fichero <code>Database.php</code> para que se configure con las variables de entorno que indicamos al crear el contenedor.</p>
<p>la ruta es la siguiente:</p>
<pre class="language-txt"><code class="language-txt">usuario@debian:~/docker/practica/bookmedik$ nano core/controller/Database.php</code></pre>
<p>El fichero queda de la siguiente manera:</p>
<pre class="language-php"><code class="language-php"><span class="token php language-php"><span class="token delimiter important">&lt;?php</span><br><span class="token keyword">class</span> <span class="token class-name-definition class-name">Database</span> <span class="token punctuation">{</span><br>        <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token variable">$db</span><span class="token punctuation">;</span><br>        <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token variable">$con</span><span class="token punctuation">;</span><br>        <span class="token keyword">function</span> <span class="token function-definition function">Database</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span><br>                <span class="token variable">$this</span><span class="token operator">-></span><span class="token property">user</span><span class="token operator">=</span><span class="token function">getenv</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'USUARIO_BOOKMEDIK'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token variable">$this</span><span class="token operator">-></span><span class="token property">pass</span><span class="token operator">=</span><span class="token function">getenv</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'CONTRA_BOOKMEDIK'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token variable">$this</span><span class="token operator">-></span><span class="token property">host</span><span class="token operator">=</span><span class="token function">getenv</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'DATABASE_HOST'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token variable">$this</span><span class="token operator">-></span><span class="token property">ddbb</span><span class="token operator">=</span><span class="token function">getenv</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'NOMBRE_DB'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>        <span class="token punctuation">}</span><br><br>        <span class="token keyword">function</span> <span class="token function-definition function">connect</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span><br>                <span class="token variable">$con</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">mysqli</span><span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-></span><span class="token property">host</span><span class="token punctuation">,</span><span class="token variable">$this</span><span class="token operator">-></span><span class="token property">user</span><span class="token punctuation">,</span><span class="token variable">$this</span><span class="token operator">-></span><span class="token property">pass</span><span class="token punctuation">,</span><span class="token variable">$this</span><span class="token operator">-></span><span class="token property">ddbb</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>                <span class="token variable">$con</span><span class="token operator">-></span><span class="token function">query</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"set sql_mode=''"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>                <span class="token keyword">return</span> <span class="token variable">$con</span><span class="token punctuation">;</span><br>        <span class="token punctuation">}</span><br><br>        <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">function</span> <span class="token function-definition function">getCon</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span><br>                <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token keyword static-context">self</span><span class="token operator">::</span><span class="token variable">$con</span><span class="token operator">==</span><span class="token constant">null</span> <span class="token operator">&amp;&amp;</span> <span class="token keyword static-context">self</span><span class="token operator">::</span><span class="token variable">$db</span><span class="token operator">==</span><span class="token constant">null</span><span class="token punctuation">)</span><span class="token punctuation">{</span><br>                        <span class="token keyword static-context">self</span><span class="token operator">::</span><span class="token variable">$db</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Database</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>                        <span class="token keyword static-context">self</span><span class="token operator">::</span><span class="token variable">$con</span> <span class="token operator">=</span> <span class="token keyword static-context">self</span><span class="token operator">::</span><span class="token variable">$db</span><span class="token operator">-></span><span class="token function">connect</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>                <span class="token punctuation">}</span><br>                <span class="token keyword">return</span> <span class="token keyword static-context">self</span><span class="token operator">::</span><span class="token variable">$con</span><span class="token punctuation">;</span><br>        <span class="token punctuation">}</span><br><span class="token punctuation">}</span><br><span class="token delimiter important">?></span></span></code></pre>
<p>Una vez hecho esto, ya podremos crear el Dockerfile con el que crearemos la imagen.</p>
<ul>
<li><strong>Crea una imagen docker con la aplicación desde una imagen base de debian o ubuntu.</strong></li>
</ul>
<p>El contenido del Dockerfile es el siguiente:</p>
<pre class="language-txt"><code class="language-txt">FROM debian:bullseye<br>MAINTAINER Alejandro Montes "alejandro@alejandro-montes.es"<br>RUN apt update &amp;&amp; apt upgrade -y &amp;&amp; apt install apache2 libapache2-mod-php php php-mysql mariadb-client -y &amp;&amp; apt clean &amp;&amp; rm -rf /var/lib/apt/lists/*<br>ADD bookmedik /var/www/html/<br>ADD script.sh /opt/<br>RUN chmod +x /opt/script.sh &amp;&amp; rm /var/www/html/index.html<br>ENTRYPOINT ["/opt/script.sh"]</code></pre>
<p>Como vemos, el Dockerfile ejecuta un script, el contenido del script es el siguiente:</p>
<pre class="language-bash"><code class="language-bash"><span class="token shebang important">#! /bin/sh</span><br><br>mysql -u <span class="token variable">$USUARIO_BOOKMEDIK</span> --password<span class="token operator">=</span><span class="token variable">$CONTRA_BOOKMEDIK</span> -h <span class="token variable">$DATABASE_HOST</span> <span class="token variable">$NOMBRE_DB</span> <span class="token operator">&lt;</span> /var/www/html/schema.sql<br><br>/usr/sbin/apache2ctl -D FOREGROUND</code></pre>
<p>Una vez hecho esto, ya podemos crear la imagen:</p>
<pre class="language-txt"><code class="language-txt">usuario@debian:~/docker/practica$ docker build -t alemd01/bookmedik:v1 .<br>Sending build context to Docker daemon   5.78MB<br>Step 1/7 : FROM debian:bullseye<br>bullseye: Pulling from library/debian<br>1e4aec178e08: Pull complete <br>Digest: sha256:43ef0c6c3585d5b406caa7a0f232ff5a19c1402aeb415f68bcd1cf9d10180af8<br>Status: Downloaded newer image for debian:bullseye<br> ---> 54e726b437fb<br>Step 2/7 : MAINTAINER Alejandro Montes "alejandro@alejandro-montes.es"<br> ---> Running in 1647cfd1e95c<br>Removing intermediate container 1647cfd1e95c<br> ---> a59b1bdf1432<br>Step 3/7 : RUN apt update &amp;&amp; apt upgrade -y &amp;&amp; apt install apache2 libapache2-mod-php php php-mysql mariadb-client -y &amp;&amp; apt clean &amp;&amp; rm -rf /var/lib/apt/lists/*<br> ---> Running in 0f4011dfed2b</code></pre>
<p>Como podemos ver la imagen se ha creado correctamente:</p>
<pre class="language-txt"><code class="language-txt">usuario@debian:~/docker/practica$ docker images<br>REPOSITORY                TAG          IMAGE ID       CREATED          SIZE<br>alemd01/bookmedik         v1           d30f6251c040   14 minutes ago   302MB<br>debian                    bullseye     54e726b437fb   10 days ago      124MB<br>alemd01/mi_servidor_web   v2           4c59dc832620   12 days ago      239MB<br>alemd01/mi_servidor_web   v1           b1421e4328a1   12 days ago      239MB<br>nextcloud                 latest       2af5f013b660   2 weeks ago      1.02GB<br>debian                    latest       20473158e8b3   2 weeks ago      124MB<br>mariadb                   10.5         817e0c16a766   2 weeks ago      402MB<br>mariadb                   latest       039bd724508b   2 weeks ago      410MB<br>httpd                     2.4          6e794a483258   4 weeks ago      145MB<br>ubuntu                    latest       6b7dfa7e8fdb   2 months ago     77.8MB<br>php                       7.4-apache   20a3732f422b   3 months ago     453MB<br>hello-world               latest       feb5d9fea6a5   17 months ago    13.3kB</code></pre>
<h3 id="despliegue-en-el-entorno-de-desarrollo." tabindex="-1">Despliegue en el entorno de desarrollo.</h3>
<ul>
<li><strong>Crea un script con docker-compose que levante el escenario con los dos contenedores.</strong></li>
<li><strong>Recuerda que para acceder a la aplicación: Usuario: admin, contraseña: admin.</strong></li>
</ul>
<p>Vamos a crear el fichero docker-compose con la configuración necesaria para levantar los dos contenedores:</p>
<pre class="language-yaml"><code class="language-yaml"><span class="token key atrule">version</span><span class="token punctuation">:</span> <span class="token string">'3.1'</span><br><span class="token key atrule">services</span><span class="token punctuation">:</span><br>  <span class="token key atrule">bookmedik</span><span class="token punctuation">:</span><br>    <span class="token key atrule">container_name</span><span class="token punctuation">:</span> bookmedik<span class="token punctuation">-</span>app<br>    <span class="token key atrule">image</span><span class="token punctuation">:</span> alemd01/bookmedik<span class="token punctuation">:</span>v1<br>    <span class="token key atrule">restart</span><span class="token punctuation">:</span> always<br>    <span class="token key atrule">environment</span><span class="token punctuation">:</span><br>      <span class="token key atrule">USUARIO_BOOKMEDIK</span><span class="token punctuation">:</span> bookmedik<br>      <span class="token key atrule">CONTRA_BOOKMEDIK</span><span class="token punctuation">:</span> bookmedik<br>      <span class="token key atrule">DATABASE_HOST</span><span class="token punctuation">:</span> bd_mariadb<br>      <span class="token key atrule">NOMBRE_DB</span><span class="token punctuation">:</span> bookmedik<br>    <span class="token key atrule">ports</span><span class="token punctuation">:</span><br>      <span class="token punctuation">-</span> 8081<span class="token punctuation">:</span><span class="token number">80</span><br>    <span class="token key atrule">depends_on</span><span class="token punctuation">:</span><br>      <span class="token punctuation">-</span> db<br>  <span class="token key atrule">db</span><span class="token punctuation">:</span><br>    <span class="token key atrule">container_name</span><span class="token punctuation">:</span> bd_mariadb<br>    <span class="token key atrule">image</span><span class="token punctuation">:</span> mariadb<br>    <span class="token key atrule">restart</span><span class="token punctuation">:</span> always<br>    <span class="token key atrule">environment</span><span class="token punctuation">:</span><br>      <span class="token key atrule">MARIADB_ROOT_PASSWORD</span><span class="token punctuation">:</span> root<br>      <span class="token key atrule">MARIADB_DATABASE</span><span class="token punctuation">:</span> bookmedik<br>      <span class="token key atrule">MARIADB_USER</span><span class="token punctuation">:</span> bookmedik<br>      <span class="token key atrule">MARIADB_PASSWORD</span><span class="token punctuation">:</span> bookmedik<br>    <span class="token key atrule">volumes</span><span class="token punctuation">:</span><br>      <span class="token punctuation">-</span> mariadb_data<span class="token punctuation">:</span>/var/lib/mysql<br><span class="token key atrule">volumes</span><span class="token punctuation">:</span><br>    <span class="token key atrule">mariadb_data</span><span class="token punctuation">:</span></code></pre>
<p>Levantamos los contenedores:</p>
<pre class="language-txt"><code class="language-txt">usuario@debian:~/docker/practica$ docker-compose up -d<br>Creating bd_mariadb ... done<br>Creating bookmedik-app ... done</code></pre>
<h3 id="creaci%C3%B3n-de-una-imagen-docker-con-una-aplicaci%C3%B3n-web-desde-una-imagen-php." tabindex="-1">Creación de una imagen docker con una aplicación web desde una imagen PHP.</h3>
<ul>
<li><strong>Vamos a crear una imagen que se llame usuario/bookmedik:v2.</strong></li>
<li><strong>Realiza la imagen docker de la aplicación a partir de la imagen oficial PHP que encuentras en docker hub. Lee la documentación de la imagen para configurar una imagen con apache2 y php, además seguramente tengas que instalar alguna extensión de php.</strong></li>
<li><strong>Modifica el fichero docker-compose.yml` para probar esta imagen.</strong></li>
</ul>
<h3 id="ejecuci%C3%B3n-de-una-aplicaci%C3%B3n-php-en-docker-con-nginx-(optativa)." tabindex="-1">Ejecución de una aplicación PHP en docker con nginx (OPTATIVA).</h3>
<ul>
<li><strong>Vamos a crear una imagen que se llame usuario/bookmedik:v3.</strong></li>
<li><strong>En este caso queremos usar un contenedor que utilice nginx para servir la aplicación PHP. Puedes crear la imagen desde una imagen base debian o ubuntu o desde la imagen oficial de nginx.</strong></li>
<li><strong>Vamos a crear otro contenedor que sirva php-fpm.</strong></li>
<li><strong>Para que funcione de forma adecuada el php-fpm tiene que tener acceso al directorio donde se encuentra la aplicación.</strong></li>
<li><strong>Y finalmente nuestro contenedor con la aplicación.</strong></li>
<li><strong>Crea un script con docker compose que levante el escenario con los tres contenedores.</strong></li>
</ul>
<h3 id="puesta-en-producci%C3%B3n-de-nuestra-aplicaci%C3%B3n." tabindex="-1">Puesta en producción de nuestra aplicación.</h3>
<ul>
<li><strong>Elige una de las tres imágenes y súbela a Docker Hub.</strong></li>
<li><strong>En tu VPS instala Docker y utilizando el docker-compose.yml correspondiente, crea un contenedor en ella de la aplicación.</strong></li>
<li><strong>Configura el nginx de tu VPS para que haga de proxy inverso y nos permita acceder a la aplicación con <a href="https://bookmedik.tudominio.xxx">https://bookmedik.tudominio.xxx</a>.</strong></li>
</ul>
<h3 id="modificaci%C3%B3n-de-la-aplicaci%C3%B3n." tabindex="-1">Modificación de la aplicación.</h3>
<ul>
<li><strong>En el entorno de desarrollo vamos a hacer una modificación de la aplicación. Por ejemplo modifica el fichero core/app/view/login-view.php y pon tu nombre en la línea <code>&lt;h4 class=&quot;title&quot;&gt;Acceder a BookMedik&lt;/h4&gt;</code>.</strong></li>
<li><strong>Vamos a trabajar con la primera imagen que construimos. Vuelve a crear la imagen con la etiqueta v1_2.</strong></li>
<li><strong>Cambia el docker-compose para probar el cambio.</strong></li>
<li><strong>Modifica la aplicación en producción.</strong></li>
</ul>
<hr>
<h2 id="documento-realizado-por%3A" tabindex="-1"><strong>Documento realizado por:</strong></h2>
<p>✒️ <strong>Alejandro Montes Delgado</strong> - <em>2º ASIR</em></p>

        </div>
            <p class="uppercase text-xs mt-6">Siguiente post</p>
            <p class="font-bold mb-2">
                <a href="/post/ejercicios-de-k8s-v./">Ejercicios de K8s V.</a>
            </p>
        
            <p class="uppercase text-xs mt-6">Post anterior.</p>

            <p class="font-bold">
                <a href="/post/ldaps/">LDAPs</a>
            </p>
        
    </div>

    </main>
    <footer class="bg-gray-900 pb-10">
  <p class="block text-center text-sm mb-6">
    Built by
    <a target="_blank" href="https://github.com/reeseschultz">
      Reese Schultz
    </a>
  </p>

  <a class="block text-center text-sm" href="/privacy-policy">Privacy Policy</a>
</footer>
    <script src="https://unpkg.com/clipboard@2/dist/clipboard.min.js"></script>
    <script src="/assets/main.bundle.js"></script>
  </body>
</html>
