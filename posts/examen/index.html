<h3 id="pr%C3%A1ctica-8%3A-movimiento-de-datos." tabindex="-1">Práctica 8: Movimiento de Datos.</h3>
<p>Lo primero que haré será crear una base de datos donde insertaré algunas tablas con los caracteres indicados:</p>
<pre class="language-txt"><code class="language-txt">examen=# CREATE TABLE PRUEBA (<br>NOMBRE VARCHAR(30),<br>APELLIDO VARCHAR(30),<br>FECHA_NACIMIENTO DATE,<br>SALARIO NUMERIC(8) <br>);                                     <br>CREATE TABLE<br>examen=# INSERT INTO PRUEBA VALUES('Juan','Perez','2000-05-15',5000);<br>INSERT 0 1<br>examen=# INSERT INTO PRUEBA VALUES('Manolo','Diaz','1999-03-11',5000);<br>INSERT 0 1<br>examen=# INSERT INTO PRUEBA VALUES('Paco','Fernandez','1999-03-11',1000);<br>INSERT 0 1<br>examen=# select * from prueba;<br> nombre | apellido  | fecha_nacimiento | salario <br>--------+-----------+------------------+---------<br> Juan   | Perez     | 2000-05-15       |    5000<br> Manolo | Diaz      | 1999-03-11       |    5000<br> Paco   | Fernandez | 1999-03-11       |    1000<br>(3 filas)<br></code></pre>
<p>Ahora con esta función la ejecutamos y nos creará el csv correspondiente de la tabla:</p>
<pre class="language-txt"><code class="language-txt">examen=# CREATE OR REPLACE FUNCTION exportar_tablas_a_csv(<br>    _nombre_de_la_base_de_datos TEXT,<br>    _ruta TEXT<br>)<br>RETURNS VOID AS $$<br>DECLARE<br>    _nombre_de_la_tabla TEXT;<br>BEGIN<br>    FOR _nombre_de_la_tabla IN<br>        SELECT table_name<br>        FROM information_schema.tables<br>        WHERE table_schema = 'public'<br>        AND table_type = 'BASE TABLE'<br>    LOOP<br>        EXECUTE format(<br>            'COPY %I TO %L WITH (FORMAT CSV, DELIMITER ";", HEADER)',<br>            _nombre_de_la_tabla,<br>            _ruta || _nombre_de_la_tabla || '.csv'<br>        );<br>    END LOOP;<br>END;<br>$$ LANGUAGE plpgsql;<br>CREATE FUNCTION</code></pre>
<p>ejecutamos la función:</p>
<pre class="language-txt"><code class="language-txt">examen=# SELECT exportar_tablas_a_csv('prueba', '/var/lib/postgresql/');<br> exportar_tablas_a_csv <br>-----------------------<br> <br>(1 fila)<br></code></pre>
<p>Muestro el archivo que se ha creado:</p>
<pre class="language-txt"><code class="language-txt">nombre;apellido;fecha_nacimiento;salario<br>Juan;Perez;2000-05-15;5000<br>Manolo;Diaz;1999-03-11;5000<br>Paco;Fernandez;1999-03-11;1000</code></pre>
<p>Ahora me paso este csv a nuestro servidor oracle y lo cargaremos con sqlloader. Creo la tabla en oracle donde vamos a cargar los datos:</p>
<pre class="language-txt"><code class="language-txt">SQL> CREATE TABLE prueba (<br>  2  NOMBRE VARCHAR2(30),<br>  3  APELLIDO VARCHAR2(30),<br>  4  FECHA_NACIMIENTO DATE,<br>  5  SALARIO NUMBER(8)<br>  6  );<br><br>Tabla creada.<br></code></pre>
<p>Muestro el fichero de control que vamos a usar:</p>
<pre class="language-txt"><code class="language-txt">OPTIONS (SKIP=1)<br>LOAD DATA<br>INFILE '/home/usuario/oracle/prueba.csv'<br>INTO TABLE prueba<br>FIELDS TERMINATED BY ';' OPTIONALLY ENCLOSED BY '"'<br>TRAILING NULLCOLS<br>(NOMBRE, APELLIDO, FECHA_NACIMIENTO DATE "YYYY-MM-DD", SALARIO)<br></code></pre>
<p>Muestro la salida del comando:</p>
<pre class="language-txt"><code class="language-txt">usuario@oracle:~/oracle$ sqlldr c##servidor2/usuario control=/home/usuario/oracle/prueba.ctl log=/home/usuario/oracle/prueba.log<br><br>SQL*Loader: Release 19.0.0.0.0 - Production on Tue Mar 7 11:17:37 2023<br>Version 19.3.0.0.0<br><br>Copyright (c) 1982, 2019, Oracle and/or its affiliates.  All rights reserved.<br><br>Path used:      Conventional<br>Commit point reached - logical record count 3<br><br>Table PRUEBA:<br>  3 Rows successfully loaded.<br><br>Check the log file:<br>  /home/usuario/oracle/prueba.log<br>for more information about the load.<br></code></pre>
<p>Como vemos se han añadido 3 filas correctamente, a continuación consulto la tabla:</p>
<pre class="language-txt"><code class="language-txt"><br>SQL> SELECT * FROM prueba;<br><br>NOMBRE			       APELLIDO 		      FECHA_NA<br>------------------------------ ------------------------------ --------<br>   SALARIO<br>----------<br>Juan			       Perez			      15/05/00<br>      5000<br><br>Manolo			       Diaz			      11/03/99<br>      5000<br><br>Paco			       Fernandez		      11/03/99<br>      1000<br></code></pre>
<h3 id="pr%C3%A1ctica-9%3A-copias-de-seguridad-y-restauraci%C3%B3n." tabindex="-1">Práctica 9: Copias de seguridad y Restauración.</h3>
<p>Creamos un tablespace y una tabla que contenga ese tablespace:</p>
<pre class="language-txt"><code class="language-txt">SQL> CREATE TABLESPACE EXAMEN_TS DATAFILE 'examen_ts.dbf' SIZE 5M AUTOEXTEND ON;<br><br>Tablespace creado.<br><br>SQL> CREATE TABLE examen (<br>  2  NOMBRE VARCHAR2(30),<br>  3  APELLIDO VARCHAR2(30),<br>  4  FECHA_NACIMIENTO DATE,<br>  5  SALARIO NUMBER(8)<br>  6  ) TABLESPACE EXAMEN_TS;<br><br>Tabla creada.<br></code></pre>
<p>Inserto registros en las tablas:</p>
<pre class="language-txt"><code class="language-txt"><br>SQL> INSERT INTO examen VALUES ('Juan','Perez',TO_DATE('2000-05-15','YYYY-MM-DD'), 5000);<br><br>1 fila creada.<br><br>SQL> INSERT INTO examen VALUES ('Manolo','Diaz',TO_DATE('1999-03-11','YYYY-MM-DD'), 5000);<br><br>1 fila creada.<br><br>SQL> INSERT INTO examen VALUES ('Paco','Fernandez',TO_DATE('1999-03-11','YYYY-MM-DD'), 1000);<br><br>1 fila creada.<br></code></pre>
<p>Ahora consultamos donde se encuentra el tablespace creado:</p>
<pre class="language-txt"><code class="language-txt">SQL> SELECT FILE_NAME FROM DBA_DATA_FILES WHERE TABLESPACE_NAME = 'TS_EXAMEN';<br><br>FILE_NAME<br>--------------------------------------------------------------------------------<br>/opt/oracle/product/19c/dbhome_1/dbs/examen_ts.dbf<br></code></pre>
<p>Ahora nos conectamos con RMAN y realizamos el backup en caliente para ello primero registramos la base de datos y después ejecutamos el backup:</p>
<pre class="language-txt"><code class="language-txt">RMAN> REGISTER DATABASE;<br><br>database registered in recovery catalog<br>starting full resync of recovery catalog<br>full resync complete<br><br>RMAN> BACKUP DATABASE;<br><br>Starting backup at 07-MAR-23<br>allocated channel: ORA_DISK_1<br>channel ORA_DISK_1: SID=269 device type=DISK<br>channel ORA_DISK_1: starting full datafile backup set<br>channel ORA_DISK_1: specifying datafile(s) in backup set<br>input datafile file number=00001 name=/opt/oracle/oradata/ORCLCDB/system01.dbf<br>input datafile file number=00003 name=/opt/oracle/oradata/ORCLCDB/sysaux01.dbf<br>input datafile file number=00014 name=/opt/oracle/oradata/ORCLCDB/TS_RAMN.dbf<br>input datafile file number=00004 name=/opt/oracle/oradata/ORCLCDB/undotbs01.dbf<br>input datafile file number=00007 name=/opt/oracle/oradata/ORCLCDB/users01.dbf<br>input datafile file number=00013 name=/opt/oracle/product/19c/dbhome_1/dbs/examen_ts.dbf<br>channel ORA_DISK_1: starting piece 1 at 07-MAR-23<br>channel ORA_DISK_1: finished piece 1 at 07-MAR-23<br>piece handle=/opt/oracle/product/19c/dbhome_1/dbs/021mel7j_1_1 tag=TAG20230307T114346 comment=NONE<br>channel ORA_DISK_1: backup set complete, elapsed time: 00:01:57<br>channel ORA_DISK_1: starting full datafile backup set<br>channel ORA_DISK_1: specifying datafile(s) in backup set<br>input datafile file number=00010 name=/opt/oracle/oradata/ORCLCDB/ORCLPDB1/sysaux01.dbf<br>input datafile file number=00009 name=/opt/oracle/oradata/ORCLCDB/ORCLPDB1/system01.dbf<br>input datafile file number=00011 name=/opt/oracle/oradata/ORCLCDB/ORCLPDB1/undotbs01.dbf<br>input datafile file number=00012 name=/opt/oracle/oradata/ORCLCDB/ORCLPDB1/users01.dbf<br>channel ORA_DISK_1: starting piece 1 at 07-MAR-23<br>channel ORA_DISK_1: finished piece 1 at 07-MAR-23<br>piece handle=/opt/oracle/product/19c/dbhome_1/dbs/041melb9_1_1 tag=TAG20230307T114346 comment=NONE<br>channel ORA_DISK_1: backup set complete, elapsed time: 00:00:39<br>channel ORA_DISK_1: starting full datafile backup set<br>channel ORA_DISK_1: specifying datafile(s) in backup set<br>input datafile file number=00006 name=/opt/oracle/oradata/ORCLCDB/pdbseed/sysaux01.dbf<br>input datafile file number=00005 name=/opt/oracle/oradata/ORCLCDB/pdbseed/system01.dbf<br>input datafile file number=00008 name=/opt/oracle/oradata/ORCLCDB/pdbseed/undotbs01.dbf<br>channel ORA_DISK_1: starting piece 1 at 07-MAR-23<br>channel ORA_DISK_1: finished piece 1 at 07-MAR-23<br>piece handle=/opt/oracle/product/19c/dbhome_1/dbs/051melcg_1_1 tag=TAG20230307T114346 comment=NONE<br>channel ORA_DISK_1: backup set complete, elapsed time: 00:00:35<br>Finished backup at 07-MAR-23<br><br>Starting Control File and SPFILE Autobackup at 07-MAR-23<br>piece handle=/opt/oracle/product/19c/dbhome_1/dbs/c-2889820145-20230307-02 comment=NONE<br>Finished Control File and SPFILE Autobackup at 07-MAR-23<br></code></pre>
<p>Borramos el tablespace:</p>
<pre class="language-txt"><code class="language-txt">root@oracle:/opt/oracle/oradata/ORCLCDB# rm ts_examen.dbf <br></code></pre>
<p>Desactivamos el tablespace:</p>
<pre class="language-txt"><code class="language-txt">RMAN> SQL "ALTER TABLESPACE TS_EXAMEN OFFLINE IMMEDIATE";<br><br>sql statement: ALTER TABLESPACE TS_EXAMEN OFFLINE IMMEDIATE</code></pre>
<p>Restauramos el tablespace:</p>
<pre class="language-txt"><code class="language-txt">RMAN> RESTORE TABLESPACE TS_EXAMEN;<br><br>Starting restore at 07-MAR-23<br>using channel ORA_DISK_1<br><br>channel ORA_DISK_1: starting datafile backup set restore<br>channel ORA_DISK_1: specifying datafile(s) to restore from backup set<br>channel ORA_DISK_1: restoring datafile 00015 to /opt/oracle/oradata/ORCLCDB/ts_examen.dbf<br>channel ORA_DISK_1: reading from backup piece /opt/oracle/product/19c/dbhome_1/dbs/081menn7_1_1<br>channel ORA_DISK_1: piece handle=/opt/oracle/product/19c/dbhome_1/dbs/081menn7_1_1 tag=TAG20230307T122614<br>channel ORA_DISK_1: restored backup piece 1<br>channel ORA_DISK_1: restore complete, elapsed time: 00:00:03<br>Finished restore at 07-MAR-23<br><br>RMAN> </code></pre>
<p>Y lo recuperamos:</p>
<pre class="language-txt"><code class="language-txt">RMAN> RECOVER TABLESPACE TS_EXAMEN;<br><br>Starting recover at 07-MAR-23<br>using channel ORA_DISK_1<br><br>starting media recovery<br>media recovery complete, elapsed time: 00:00:01<br><br>Finished recover at 07-MAR-23<br></code></pre>
<p>Volvemos a poner online:</p>
<pre class="language-txt"><code class="language-txt">RMAN> SQL "ALTER TABLESPACE TS_EXAMEN ONLINE";<br><br>sql statement: ALTER TABLESPACE TS_EXAMEN ONLINE<br><br>RMAN> </code></pre>
<p>Probamos que funciona:</p>
<pre class="language-txt"><code class="language-txt">usuario@oracle:~$ sqlplus<br><br>SQL*Plus: Release 19.0.0.0.0 - Production on Tue Mar 7 12:35:52 2023<br>Version 19.3.0.0.0<br><br>Copyright (c) 1982, 2019, Oracle.  All rights reserved.<br><br>Enter user-name: usuario<br>Enter password: <br>Hora de Ultima Conexion Correcta: Mar Mar 07 2023 12:29:59 +01:00<br><br>Conectado a:<br>Oracle Database 19c Enterprise Edition Release 19.0.0.0.0 - Production<br>Version 19.3.0.0.0<br><br>SQL> SELECT * FROM examen;<br><br>NOMBRE			       APELLIDO 		      FECHA_NA<br>------------------------------ ------------------------------ --------<br>   SALARIO<br>----------<br>Juan			       Perez			      15/05/00<br>      5000<br><br>Manolo			       Diaz			      11/03/99<br>      5000<br><br>Paco			       Fernandez		      11/03/99<br>      1000<br><br></code></pre>
